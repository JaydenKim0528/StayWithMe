<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <title>DirEngine - Free Bootstrap 4 Template by Colorlib</title>
    <link th:insert="~{fragments/css.html :: css}"></link>
    <link rel="stylesheet" th:href="@{css/booking/booking.css}">


    <!-- jQuery -->
    <script
            type="text/javascript"
            src="https://code.jquery.com/jquery-1.12.4.min.js"></script>

    <!-- iamport.payment.js -->
    <script
            type="text/javascript"
            src="https://cdn.iamport.kr/js/iamport.payment-1.2.0.js"></script>


</head>


<body style="background-color: #0c5460">

<nav th:insert="~{fragments/navbar.html :: navbar}"></nav>
<!-- END nav -->

<div class="hero-wrap js-fullheight" style="background-image: url('../static/images/bg_4.jpg');">
    <div class=""></div>
    <div class="">
        <div class="row no-gutters slider-text js-fullheight align-items-center justify-content-center" data-scrollax-parent="true">
            <div class="col-md-9 ftco-animate text-center" data-scrollax=" properties: { translateY: '70%' }">
                <p class="breadcrumbs" data-scrollax="properties: { translateY: '30%', opacity: 1.6 }"><span class="mr-2"><a href="index.html">Home</a></span> <span>Blog</span></p>
                <h1 class="mb-3 bread" data-scrollax="properties: { translateY: '30%', opacity: 1.6 }">예약</h1>
            </div>
        </div>
    </div>
</div>
<form id="terms-form" action="/payment" method="POST">
    <div class="container1">
        <div class="section">
            <input type="hidden" id="roomNo" th:value="${list.roomNo}">
            <h1 th:text="${list.accommodationName}"></h1>
            <h3 id="product-name" th:text="${list.roomName}"></h3>
            <div class="form-group form-inline">
                <label for="check-out"> 일정 </label>
                <span th:text="${checkIn}" id="checkInDate"></span><input type="text" id="check-out" th:value="${list.roomCheckIn}" style="border: none; display: block;" readonly /><br>
                <span th:text="${checkOut}" id="checkOutDate"></span><input type="text" id="check" th:value="${list.roomCheckOut}" style="border: none;" readonly />
            </div>
            <div class="form-group">
                <label>기준 인원</label>
                <input type="text" th:value="${list.roomPersonnel}" readonly />
                <label>최대 인원</label>
                <input type="text" th:value="${list.roomMaxPersonnel}" readonly />

            </div>
        </div>

        <div class="section">
            <h3>예약자 정보</h3>
            <div class="form-group">
                <input type="text" id="name" th:value="${user.userName}" />
            </div>
            <div class="form-group">
                <input type="text" id="phone" th:value="${user.userPhone}" style="flex: 1;" />
            </div>
        </div>


        <!-- 쿠폰 리스트를 위한 모달 -->
        <div class="section">
            <label for="selected-coupon">쿠폰</label>
            <div class="button-group">
                <input type="text" id="selected-coupon" placeholder="쿠폰을 선택하세요" onclick="openCouponModal()" readonly/>
                <button type="button" onclick="cancelCouponSelection()">취소</button> <!-- 적용 버튼을 취소 버튼으로 변경 -->
            </div>
        </div>

        <!-- 쿠폰 리스트를 위한 모달 -->
        <div id="coupon-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeCouponModal()">&times;</span>
                <h2>쿠폰 선택</h2>
                <ul id="coupon-list" th:each="coupon : ${coupons}">
                    <!-- 쿠폰 리스트 항목들이 여기에 추가될 것입니다. -->
                    <div onclick="selectCoupon(this)"
                         th:data-coupon-id="${coupon.couponId}"
                         th:data-coupon-name="${coupon.couponName}"
                         th:data-coupon-type="${coupon.couponType}"
                         th:data-coupon-discount="${coupon.couponDiscount}"
                         th:data-coupon-start="${coupon.couponStartDate}"
                         th:data-coupon-end="${coupon.couponEndDate}">
                        <li th:text="${coupon.couponName}"></li>
                        <li th:text="${coupon.couponType == 'DISCOUNT_RATE' ? coupon.couponDiscount + '%' : coupon.couponDiscount + '원'}"></li>
                        <li th:text="${coupon.couponStartDate} + ' ~ ' + ${coupon.couponEndDate}"></li>
                    </div>
                </ul>
            </div>
        </div>

        <div class="terms-section">
            <div class="checkbox-container">
                <input type="checkbox" id="agree-all" onclick="toggleAllCheckboxes(this)">
                <label for="agree-all">약관 전체동의</label>
            </div>
            <div class="terms-container">
                <div class="terms-item">
                    <div class="checkbox-container">
                        <input type="checkbox" id="term1" class="individual-term" onclick="toggleAgreeAll()">
                        <label for="term1">숙소 이용규칙 및 취소/환불규정 동의 (필수)</label>
                        <span class="expand" onclick="openModal('modal1')">&gt;</span>
                    </div>
                    <div id="modal1" class="modal">
                        <div class="modal-content">
                            <span class="close" onclick="closeModal('modal1')">&times;</span>
                            <b>이용규칙 내용</b>
                            <p>최대 인원 초과 시 입실이 불가합니다.</p>
                            <p>정원 기준 요금 외 인원 추가 요금을 포함하여 조식, 침구, 침대 등의 추가 요금은 예약 시 옵션으로 선택하여 선결제하실 수 있습니다.</p>
                            <p>선결제 하지 않거나 예약 시 옵션에 포함되지 않은 추가 비용이 있을 시 이는 현장결제 대상입니다.</p>
                            <p>제공 이미지는 배정된 객실과 다를 수 있습니다.</p>
                            <p>제공 정보는 숙소의 사정에 따라 변경될 수 있습니다.</p>
                            <p>미성년자는 보호자 동반 시 투숙이 가능합니다.</p>
                            <p>반려동물은 숙소 규정에 따라 출입이 제한되오니 숙소별 상세정보를 꼭 확인해 주세요.</p>
                            <p>체크인 시 배정의 경우, 객실과 베드 타입을 보장하지 않습니다.</p>
                            <p>객실 타입에 시간이 별도 기재된 경우, 체크인/아웃 시간이 상이할 수 있습니다.</p>
                            <p>업체 현장에서 객실 컨디션 및 서비스로 인해 발생된 분쟁은 여기어때에서 책임지지 않습니다.</p>

                            <b>취소/환불규정 내용</b>
                            <p>여기어때에서 판매되는 국내 호텔/리조트/펜션/게스트하우스/캠핑/홈앤빌라 상품은 예약/결제 후 10분 이내에는 무료취소 가능합니다. (단, 체크인 시간 경과 시 취소불가)</p>
                            <p>숙소 사정에 의해 취소 발생 시 100% 환불이 가능합니다.</p>
                            <p>예약 상품 환불 및 정보에 기재된 취소, 환불 규정을 반드시 확인 후 이용해주시기 바랍니다.</p>
                            <p>예약/결제 10분 이후의 취소는 업체의 취소/환불 규정에 의거하여 적용됩니다.</p>
                            <p>취소, 변경 불가 상품은 규정상 결제완료 이후에는 취소, 변경이 불가합니다.</p>
                        </div>
                    </div>
                </div>
                <div class="terms-item">
                    <div class="checkbox-container">
                        <input type="checkbox" id="term2" class="individual-term" onclick="toggleAgreeAll()">
                        <label for="term2">개인정보 수집 및 이용 동의 (필수)</label>
                        <span class="expand" onclick="openModal('privacy-modal2')">&gt;</span>
                    </div>
                    <div id="privacy-modal2" class="privacy-modal">
                        <div class="privacy-modal-content">
                            <span class="privacy-close" onclick="closeModal('privacy-modal2')">&times;</span>
                            <h2>개인정보 수집 및 이용 동의</h2>
                            <table class="privacy-table">
                                <tr>
                                    <th class="privacy-th">구분</th>
                                    <th class="privacy-th">수집 목적</th>
                                    <th class="privacy-th">수집 항목</th>
                                    <th class="privacy-th">보유 및 이용기간</th>
                                </tr>
                                <tr>
                                    <td rowspan="4" class="privacy-td">필수</td>
                                    <td class="privacy-td">예약/구매 서비스 제공 상담 및 부가 정거래 기록 확인</td>
                                    <td class="privacy-td">
                                        [예약·구매]<br>
                                        예약자 정보(이름, 휴대전화번호)<br><br>
                                        [결제]<br>
                                        거래내역<br>
                                        *결제 시 개인정보는 PG사(결제대행업체)에서 수집 및 저장하고 있으며, 회사는 PG사에서 제공하는 거래 내역만 제공받음<br><br>
                                        [거래명세서 발급]<br>
                                        이메일주소<br><br>
                                        [현금영수증 발급]<br>
                                        휴대전화번호, 이메일주소<br><br>
                                        [취소·환불]<br>
                                        은행명, 계좌번호, 예금주명
                                    </td>
                                    <td rowspan="4" class="privacy-td">- 회원 탈퇴 시 까지<br>* 관계 법령에 따라 보존할 필요가 있는 경우 해당 법령에서 요구하는 기한까지 보유</td>
                                </tr>
                            </table>
                            <div class="notice">
                                ※ 위 등의 내용을 거부하실 수 있으나, 동의를 거부하실 경우 서비스를 이용하실 수 없습니다.<br>
                                ※ 개인정보 처리와 관련된 상세 내용은 '개인정보처리방침'을 참고
                            </div>
                        </div>
                    </div>
                </div>



                <div class="terms-item">
                    <div class="checkbox-container">
                        <input type="checkbox" id="term4" class="individual-term" onclick="toggleAgreeAll()">
                        <label for="term4">만 14세 이상 확인 (필수)</label>
                        <span class="expand" onclick="openModal('privacy-modal4')">&gt;</span>
                    </div>
                    <div id="privacy-modal4" class="modal">
                        <div class="modal-content">
                            <span class="close" onclick="closeModal('privacy-modal4')">&times;</span>
                            <h2>만 14세 이상 확인 (필수)</h2>
                            <p style="color: red;">여기어때는 <strong>만 14세 미만 아동의 서비스 이용을 제한하고 있습니다.</strong></p>
                            <p>개인정보 보호법에는 만 14세 미만 아동의 개인정보 수집 시 법정대리인 동의를 받도록 규정하고 있으며, <strong>만 14세 미만 아동이 법정대리인 동의없이 서비스 이용이 확인된 경우 서비스 이용이 제한될 수 있음을 알려드립니다.</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="price-info">

            <div>
                객실 가격 ( 1 박 기준 ): <span class="price" id="base-price-span" th:text="${price}">원</span> 원
            </div>
            <div id="discount-amount">
                할인 가격 : <span class="price" id="discount-price-span" th:text="0"></span>
            </div>
            <hr style="color: black;background-color: black">
            <div>
                총 결제 금액 : <span class="final-price" id="final-price-span" th:text="${price}"></span> 원
            </div>
        </div>

        <!-- Hidden input fields to send data to the server -->
        <input type="hidden" id="basic-price" name="basic-price" />
        <input type="hidden" id="discount-price" name="discount-price" />
        <input type="hidden" id="final-price" name="final-price" />

        <button type="submit" class="pay-button">결제하기</button>
    </div>
</form>


<script>

    // 쿠폰 가격 적용
    let discountAmount = (document.getElementById('discount-price').value = document.getElementById("discount-price-span").textContent);
    let basicPrice = (document.getElementById('basic-price').value = document.getElementById('base-price-span').textContent.trim());
    let finalPrice = (document.getElementById('final-price').value = document.getElementById('final-price-span').textContent.trim());

    let selectedCouponId = null;

    function openCouponModal() {
        document.getElementById('coupon-modal').style.display = "block";
    }

    function closeCouponModal() {
        document.getElementById('coupon-modal').style.display = "none";
    }

    function selectCoupon(element) {
        const couponName = element.getAttribute('data-coupon-name');
        selectedCouponId = element.getAttribute('data-coupon-id');
        const discountType = element.getAttribute('data-coupon-type');
        const discountValue = parseInt(element.getAttribute('data-coupon-discount'));

        // 선택한 쿠폰 이름을 인풋 필드에 표시
        document.getElementById('selected-coupon').value = couponName;

        // 쿠폰을 적용
        applyCoupon(discountType, discountValue);

        // 모달 닫기
        closeCouponModal();
    }

    function cancelCouponSelection() {
        // 선택된 쿠폰 정보를 초기화
        selectedCouponId = null;
        document.getElementById('selected-coupon').value = '';

        // 기존 할인 정보를 제거하고 기본 가격을 다시 설정
        document.getElementById('discount-price').value = 0;
        document.getElementById('discount-price-span').textContent = '0';
        finalPrice = basicPrice;
        document.getElementById('final-price-span').textContent = basicPrice;

        // 모달 닫기
        closeCouponModal();
    }
    function applyCoupon(discountType, discountValue) {

        if (discountType === 'DISCOUNT_RATE') {
            discountAmount = Math.floor(basicPrice * (discountValue / 100)); // 퍼센트 할인을 계산
        } else if (discountType === 'DISCOUNT_AMOUNT') {
            discountAmount = discountValue; // 금액 할인을 그대로 적용
        }

        finalPrice = basicPrice - discountAmount;

        // 최종 가격을 업데이트
        document.getElementById('final-price-span').textContent = finalPrice;

        // 할인 금액을 표시
        let discountElement = document.getElementById('discount-amount');
        if (!discountElement) {
            discountElement = document.createElement('p');
            discountElement.id = 'discount-amount';
            document.getElementById('price-section').appendChild(discountElement);
        }
        discountElement.textContent = `할인 가격: ${discountAmount} 원`;
    }



    function toggleAllCheckboxes(source) {
        const checkboxes = document.querySelectorAll('.individual-term');
        checkboxes.forEach(checkbox => {
            checkbox.checked = source.checked;
        });
    }

    function toggleAgreeAll() {
        const agreeAll = document.getElementById('agree-all');
        const checkboxes = document.querySelectorAll('.individual-term');
        agreeAll.checked = [...checkboxes].every(checkbox => checkbox.checked);
    }

    function openModal(modalId) {
        document.getElementById(modalId).style.display = "block";
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = "none";
    }

    document.getElementById('terms-form').addEventListener('submit', function(event) {

        event.preventDefault();

        const requiredCheckboxes = document.querySelectorAll('.individual-term');
        const allChecked = [...requiredCheckboxes].every(checkbox => checkbox.checked);
        if (!allChecked) {
            alert("필수 항목을 모두 체크해야 제출할 수 있습니다.");
            event.preventDefault();
        } else {
            // 모든 필수 항목이 체크되었을 때 requestPay() 함수를 실행합니다.
            reserveSave();
        }
    });

    function generateMerchantUID() {
        const prefix = "SWM";
        const today = new Date();

        // 오늘 날짜를 "YYMMDD" 형식으로 만듭니다.
        const year = String(today.getFullYear()).slice(2); // '24'
        const month = String(today.getMonth() + 1).padStart(2, '0'); // '08'
        const day = String(today.getDate()).padStart(2, '0'); // '29'

        const datePart = year + month + day; // '240829'

        // 순차적인 숫자를 만들기 위한 기본 값 (예: '00001')
        let sequence = localStorage.getItem('sequence');

        if (sequence === null) {
            sequence = 1;
        } else {
            sequence = parseInt(sequence) + 1;
        }

        localStorage.setItem('sequence', sequence); // 현재 시퀀스를 로컬 스토리지에 저장

        const sequenceString = String(sequence).padStart(5, '0'); // '00001'

        // 무작위 4자리 숫자 생성
        const randomPart = String(Math.floor(Math.random() * 10000)).padStart(4, '0');

        // 완성된 주문번호를 반환합니다.
        return prefix + datePart + sequenceString + randomPart;

    }

    function reserveSave() {
        const checkInDate = document.getElementById("checkInDate").textContent;
        const checkOutDate = document.getElementById("checkOutDate").textContent;
        const roomNo = document.getElementById("roomNo").value;

        // 데이터 객체를 만듭니다.
        const data = {
            checkInDate: checkInDate,
            checkOutDate: checkOutDate,
            selectedCouponId: selectedCouponId,
            roomNo: roomNo,
            finalPrice: finalPrice
        };

        $.ajax({
            url: "/reserve-save",
            method: "POST",
            data: JSON.stringify(data),  // JSON 형식으로 데이터 전송
            contentType: "application/json",
            success: function(response) {

                // 서버에서 긍정적인 응답을 받으면 결제 함수 호출
                if (response.status === "success") {
                    var reNo = response.saveNo;
                    let finalAmount = response.reserveAmount;
                    requestPay(reNo, finalAmount);
                } else {
                    alert("예약 처리에 실패했습니다. 다시 시도해주세요.");
                }
            },
            error: function(error) {
                console.error("예약 처리 중 오류 발생:", error);
                alert("예약 처리 중 오류가 발생했습니다. 다시 시도해주세요.");
            }
        })

    }

    var productName = document.getElementById("product-name").textContent;
    var IMP = window.IMP;
    IMP.init("imp67844376");

    function requestPay(reNo, finalAmount) {
        const merchantUID = generateMerchantUID();

        // hidden input 생성
        let form = document.getElementById('terms-form');
        let reservationHiddenInput = document.createElement('input');
        reservationHiddenInput.type = 'hidden';
        reservationHiddenInput.name = 'reNo';
        reservationHiddenInput.value = reNo;
        form.appendChild(reservationHiddenInput);

        let amountHiddenInput = document.createElement('input');
        amountHiddenInput.type = 'hidden';
        amountHiddenInput.name = 'reserveAmount';
        amountHiddenInput.value = finalAmount;
        form.appendChild(amountHiddenInput);

        IMP.request_pay(
            {
                pg: "html5_inicis",		// KG이니시스 PG 파라미터 값
                pay_method: "CARD",		// 결제 방법
                merchant_uid: merchantUID, // 주문번호
                name: productName,		// 상품명
                amount: finalAmount,		// 금액
                buyer_email: "example@example.com",
                buyer_name: "홍길동",
                buyer_tel: "010-1234-5678",
            },
            function (rsp) {
                if (rsp.success) {
                    // 결제 성공 시
                    jQuery.ajax({
                        url: "http://localhost:8080/payments/complete", // 가맹점 서버
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        data: JSON.stringify({
                            imp_uid: rsp.imp_uid,
                            merchant_uid: rsp.merchant_uid
                        })
                    }).done(function (data) {
                        // 서버로부터 성공적으로 응답을 받은 경우
                        console.log("서버 응답 성공:", data);

                        if (data) {
                            // 결제 성공한 imp_uid와 기타 필요한 정보를 폼에 추가
                            let form = document.getElementById('terms-form'); // form 요소 가져오기
                            let uidHiddenInput = document.createElement('input');
                            uidHiddenInput.type = 'hidden';
                            uidHiddenInput.name = 'uid';
                            uidHiddenInput.value = rsp.imp_uid; // 서버에서 받은 imp_uid 사용
                            form.appendChild(uidHiddenInput);

                            let methodHiddenInput = document.createElement('input');
                            methodHiddenInput.type = 'hidden';
                            methodHiddenInput.name = 'method';
                            methodHiddenInput.value = rsp.pay_method; // 서버에서 받은 imp_uid 사용
                            form.appendChild(methodHiddenInput);

                            // 폼 제출
                            document.getElementById('terms-form').submit();
                        } else {
                            alert("서버에서 결제 완료 처리를 실패했습니다.");
                        }
                    }).fail(function (jqXHR, textStatus, errorThrown) {
                        console.error("서버 요청 실패:", textStatus, errorThrown);
                        alert("서버 요청 중 오류가 발생했습니다.");
                    });
                } else {
                    alert("결제에 실패하였습니다. 에러 내용: " + rsp.error_msg);
                }
            }
        );
    }


</script>

<div th:insert="~{fragments/footer.html :: footer}"></div>
<!-- loader -->
<div id="ftco-loader" class="show fullscreen"><svg class="circular" width="48px" height="48px"><circle class="path-bg" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke="#eeeeee"/><circle class="path" cx="24" cy="24" r="22" fill="none" stroke-width="4" stroke-miterlimit="10" stroke="#F96D00"/></svg></div>

</body>
<div th:insert="~{fragments/js.html :: js}"></div>
</html>